<!DOCTYPE html>
<html lang="en" data-app="TransactionHarness">
  <head>
    <meta charset="utf-8" />
    <title>Transaction Query API Test Harness</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap (minimal, clean) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>

  <body class="bg-light">
    <main class="container py-4" data-scope="page">
      <header class="mb-4">
        <h1 class="h3 mb-1">Transaction Query API Test Harness</h1>
        <p class="text-muted mb-0">
          Test all transaction query methods with pagination. Uses optimized indexes for fast queries.
        </p>
      </header>

      <!-- GLOBAL CONTROLS -->
      <section class="card mb-3" data-scope="global-inputs">
        <div class="card-body row g-3">
          <div class="col-md-3">
            <label class="form-label">Transaction ID</label>
            <input
              class="form-control"
              placeholder="123"
              data-field="transactionId"
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">User ID (Customer UID)</label>
            <input
              class="form-control"
              placeholder="CUST-99999"
              data-field="userId"
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">Owner ID</label>
            <input
              class="form-control"
              placeholder="OWNER-001"
              data-field="ownerId"
            />
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button
              class="btn btn-primary w-100"
              data-dispatch="TransactionUI:global:FillDemoIds"
            >
              Fill Demo IDs
            </button>
          </div>
        </div>
      </section>

      <!-- PAGINATION CONTROLS -->
      <section class="card mb-3" data-scope="pagination-inputs">
        <div class="card-body row g-3">
          <div class="col-md-3">
            <label class="form-label">Limit</label>
            <input
              class="form-control"
              type="number"
              min="1"
              max="100"
              value="20"
              data-field="limit"
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">Offset</label>
            <input
              class="form-control"
              type="number"
              min="0"
              value="0"
              data-field="offset"
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">Start Date</label>
            <input
              class="form-control"
              type="date"
              data-field="startDate"
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">End Date</label>
            <input
              class="form-control"
              type="date"
              data-field="endDate"
            />
          </div>
        </div>
      </section>

      <!-- OUTPUT -->
      <section class="mb-4" data-scope="output">
        <label class="form-label">Response JSON (raw)</label>
        <textarea
          class="form-control"
          rows="10"
          spellcheck="false"
          data-out="json"
        ></textarea>
      </section>

      <!-- ACCORDIONS -->
      <div class="accordion" data-accordion="root">
        <!-- BASIC QUERIES GROUP -->
        <div class="accordion-item" data-scope="basic">
          <h2 class="accordion-header">
            <button
              class="accordion-button"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="[data-pane='basic']"
            >
              üîç Basic Queries
            </button>
          </h2>
          <div class="accordion-collapse collapse show" data-pane="basic">
            <div class="accordion-body">
              <!-- Get Single Transaction -->
              <div class="card mb-3" data-scope="basic:getTransaction">
                <div class="card-body">
                  <h6 class="card-title">Get Single Transaction</h6>
                  <button
                    class="btn btn-primary"
                    data-dispatch="TransactionUI:basic:getTransaction:Clicked"
                  >
                    Get Transaction
                  </button>
                </div>
              </div>

              <!-- Get All Transactions -->
              <div class="card mb-3" data-scope="basic:getAll">
                <div class="card-body">
                  <h6 class="card-title">Get All Transactions</h6>
                  <button
                    class="btn btn-primary"
                    data-dispatch="TransactionUI:basic:getAll:Clicked"
                  >
                    Get All
                  </button>
                </div>
              </div>

              <!-- Get Transaction Count -->
              <div class="card mb-3" data-scope="basic:getCount">
                <div class="card-body">
                  <h6 class="card-title">Get Transaction Count</h6>
                  <button
                    class="btn btn-primary"
                    data-dispatch="TransactionUI:basic:getCount:Clicked"
                  >
                    Get Count
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- STATUS QUERIES GROUP -->
        <div class="accordion-item" data-scope="status">
          <h2 class="accordion-header">
            <button
              class="accordion-button collapsed"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="[data-pane='status']"
            >
              üìä Status Queries
            </button>
          </h2>
          <div class="accordion-collapse collapse" data-pane="status">
            <div class="accordion-body">
              <!-- Get by Status -->
              <div class="card mb-3" data-scope="status:getByStatus">
                <div class="card-body row g-3 align-items-end">
                  <div class="col-md-6">
                    <label class="form-label">Status</label>
                    <input
                      class="form-control"
                      value="active"
                      data-field="status"
                    />
                  </div>
                  <div class="col-md-6">
                    <button
                      class="btn btn-primary w-100"
                      data-dispatch="TransactionUI:status:getByStatus:Clicked"
                    >
                      Get by Status
                    </button>
                  </div>
                </div>
              </div>

              <!-- Get Count by Status -->
              <div class="card mb-3" data-scope="status:getCountByStatus">
                <div class="card-body row g-3 align-items-end">
                  <div class="col-md-6">
                    <label class="form-label">Status</label>
                    <input
                      class="form-control"
                      value="active"
                      data-field="statusCount"
                    />
                  </div>
                  <div class="col-md-6">
                    <button
                      class="btn btn-primary w-100"
                      data-dispatch="TransactionUI:status:getCountByStatus:Clicked"
                    >
                      Get Count by Status
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- DATE QUERIES GROUP -->
        <div class="accordion-item" data-scope="date">
          <h2 class="accordion-header">
            <button
              class="accordion-button collapsed"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="[data-pane='date']"
            >
              üìÖ Date Queries
            </button>
          </h2>
          <div class="accordion-collapse collapse" data-pane="date">
            <div class="accordion-body">
              <!-- Get by Date Range -->
              <div class="card mb-3" data-scope="date:getByDateRange">
                <div class="card-body">
                  <h6 class="card-title">Get by Date Range (with pagination)</h6>
                  <button
                    class="btn btn-primary"
                    data-dispatch="TransactionUI:date:getByDateRange:Clicked"
                  >
                    Get by Date Range
                  </button>
                </div>
              </div>

              <!-- Get All by Date Range -->
              <div class="card mb-3" data-scope="date:getAllByDateRange">
                <div class="card-body">
                  <h6 class="card-title">Get All by Date Range (no pagination)</h6>
                  <button
                    class="btn btn-primary"
                    data-dispatch="TransactionUI:date:getAllByDateRange:Clicked"
                  >
                    Get All by Date Range
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- OWNER QUERIES GROUP -->
        <div class="accordion-item" data-scope="owner">
          <h2 class="accordion-header">
            <button
              class="accordion-button collapsed"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="[data-pane='owner']"
            >
              üë§ Owner Queries
            </button>
          </h2>
          <div class="accordion-collapse collapse" data-pane="owner">
            <div class="accordion-body">
              <!-- Get by Owner -->
              <div class="card mb-3" data-scope="owner:getByOwner">
                <div class="card-body">
                  <h6 class="card-title">Get by Owner</h6>
                  <button
                    class="btn btn-primary"
                    data-dispatch="TransactionUI:owner:getByOwner:Clicked"
                  >
                    Get by Owner
                  </button>
                </div>
              </div>

              <!-- Get by Owner and Date -->
              <div class="card mb-3" data-scope="owner:getByOwnerAndDate">
                <div class="card-body">
                  <h6 class="card-title">Get by Owner and Date (with pagination)</h6>
                  <button
                    class="btn btn-primary"
                    data-dispatch="TransactionUI:owner:getByOwnerAndDate:Clicked"
                  >
                    Get by Owner and Date
                  </button>
                </div>
              </div>

              <!-- Get All by Owner and Date -->
              <div class="card mb-3" data-scope="owner:getAllByOwnerAndDate">
                <div class="card-body">
                  <h6 class="card-title">Get All by Owner and Date (no pagination)</h6>
                  <button
                    class="btn btn-primary"
                    data-dispatch="TransactionUI:owner:getAllByOwnerAndDate:Clicked"
                  >
                    Get All by Owner and Date
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- CUSTOMER QUERIES GROUP -->
        <div class="accordion-item" data-scope="customer">
          <h2 class="accordion-header">
            <button
              class="accordion-button collapsed"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="[data-pane='customer']"
            >
              üõí Customer Queries
            </button>
          </h2>
          <div class="accordion-collapse collapse" data-pane="customer">
            <div class="accordion-body">
              <!-- Get by Customer -->
              <div class="card mb-3" data-scope="customer:getByCustomer">
                <div class="card-body">
                  <h6 class="card-title">Get by Customer</h6>
                  <button
                    class="btn btn-primary"
                    data-dispatch="TransactionUI:customer:getByCustomer:Clicked"
                  >
                    Get by Customer
                  </button>
                </div>
              </div>

              <!-- Get by Customer and Date -->
              <div class="card mb-3" data-scope="customer:getByCustomerAndDate">
                <div class="card-body">
                  <h6 class="card-title">Get by Customer and Date (with pagination)</h6>
                  <button
                    class="btn btn-primary"
                    data-dispatch="TransactionUI:customer:getByCustomerAndDate:Clicked"
                  >
                    Get by Customer and Date
                  </button>
                </div>
              </div>

              <!-- Get All by Customer and Date -->
              <div class="card mb-3" data-scope="customer:getAllByCustomerAndDate">
                <div class="card-body">
                  <h6 class="card-title">Get All by Customer and Date (no pagination)</h6>
                  <button
                    class="btn btn-primary"
                    data-dispatch="TransactionUI:customer:getAllByCustomerAndDate:Clicked"
                  >
                    Get All by Customer and Date
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ORDER TYPE QUERIES GROUP -->
        <div class="accordion-item" data-scope="orderType">
          <h2 class="accordion-header">
            <button
              class="accordion-button collapsed"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="[data-pane='orderType']"
            >
              üì¶ Order Type Queries
            </button>
          </h2>
          <div class="accordion-collapse collapse" data-pane="orderType">
            <div class="accordion-body">
              <!-- Get by Order Type -->
              <div class="card mb-3" data-scope="orderType:getByOrderType">
                <div class="card-body row g-3 align-items-end">
                  <div class="col-md-6">
                    <label class="form-label">Order Type</label>
                    <input
                      class="form-control"
                      value="refund"
                      data-field="orderType"
                    />
                  </div>
                  <div class="col-md-6">
                    <button
                      class="btn btn-primary w-100"
                      data-dispatch="TransactionUI:orderType:getByOrderType:Clicked"
                    >
                      Get by Order Type
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Bootstrap JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    ></script>

    <script>
      // Utility functions
      function ensureEl(el, name) {
        if (!el) throw new Error(`Missing element: ${name}`);
        return el;
      }

      function emit(eventName, detail = {}) {
        const ev = new CustomEvent(eventName, { detail });
        window.dispatchEvent(ev);
      }

      function showOut(data) {
        const el = ensureEl(
          document.querySelector('[data-out="json"]'),
          "output textarea"
        );
        el.value = JSON.stringify(data, null, 2);
      }

      // API fetch helper
      async function apiFetch(path, options = {}) {
        const { method = "GET", body, idempotencyKey } = options;
        const headers = {
          "Content-Type": "application/json",
        };
        if (idempotencyKey) {
          headers["Idempotency-Key"] = idempotencyKey;
        }

        const res = await fetch(path, {
          method,
          headers,
          body: body ? JSON.stringify(body) : undefined,
        });

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }

        return await res.json();
      }

      // Route definitions
      const routes = {
        // Basic queries
        "TransactionUI:basic:getTransaction:Clicked": {
          method: "GET",
          path: ({ globals }) =>
            `/api/transactions/${encodeURIComponent(globals.transactionId)}`,
        },
        "TransactionUI:basic:getAll:Clicked": {
          method: "GET",
          path: ({ pagination }) =>
            `/api/transactions/all?limit=${encodeURIComponent(
              pagination.limit
            )}&offset=${encodeURIComponent(pagination.offset)}`,
        },
        "TransactionUI:basic:getCount:Clicked": {
          method: "GET",
          path: "/api/transactions/count",
        },

        // Status queries
        "TransactionUI:status:getByStatus:Clicked": {
          method: "GET",
          path: ({ globals, pagination }) =>
            `/api/transactions/by-status/${encodeURIComponent(
              globals.status
            )}?limit=${encodeURIComponent(
              pagination.limit
            )}&offset=${encodeURIComponent(pagination.offset)}`,
        },
        "TransactionUI:status:getCountByStatus:Clicked": {
          method: "GET",
          path: ({ globals }) =>
            `/api/transactions/count/by-status/${encodeURIComponent(
              globals.statusCount
            )}`,
        },

        // Date queries
        "TransactionUI:date:getByDateRange:Clicked": {
          method: "GET",
          path: ({ pagination }) =>
            `/api/transactions/by-date-range?startDate=${encodeURIComponent(
              pagination.startDate
            )}&endDate=${encodeURIComponent(
              pagination.endDate
            )}&limit=${encodeURIComponent(
              pagination.limit
            )}&offset=${encodeURIComponent(pagination.offset)}`,
        },
        "TransactionUI:date:getAllByDateRange:Clicked": {
          method: "GET",
          path: ({ pagination }) =>
            `/api/transactions/by-date-range/all?startDate=${encodeURIComponent(
              pagination.startDate
            )}&endDate=${encodeURIComponent(pagination.endDate)}`,
        },

        // Owner queries
        "TransactionUI:owner:getByOwner:Clicked": {
          method: "GET",
          path: ({ globals, pagination }) =>
            `/api/transactions/by-owner/${encodeURIComponent(
              globals.ownerId
            )}?limit=${encodeURIComponent(
              pagination.limit
            )}&offset=${encodeURIComponent(pagination.offset)}`,
        },
        "TransactionUI:owner:getByOwnerAndDate:Clicked": {
          method: "GET",
          path: ({ globals, pagination }) =>
            `/api/transactions/by-owner-and-date?ownerId=${encodeURIComponent(
              globals.ownerId
            )}&startDate=${encodeURIComponent(
              pagination.startDate
            )}&endDate=${encodeURIComponent(
              pagination.endDate
            )}&limit=${encodeURIComponent(
              pagination.limit
            )}&offset=${encodeURIComponent(pagination.offset)}`,
        },
        "TransactionUI:owner:getAllByOwnerAndDate:Clicked": {
          method: "GET",
          path: ({ globals, pagination }) =>
            `/api/transactions/by-owner-and-date/all?ownerId=${encodeURIComponent(
              globals.ownerId
            )}&startDate=${encodeURIComponent(
              pagination.startDate
            )}&endDate=${encodeURIComponent(pagination.endDate)}`,
        },

        // Customer queries
        "TransactionUI:customer:getByCustomer:Clicked": {
          method: "GET",
          path: ({ globals, pagination }) =>
            `/api/transactions/by-user/${encodeURIComponent(
              globals.userId
            )}?limit=${encodeURIComponent(
              pagination.limit
            )}&offset=${encodeURIComponent(pagination.offset)}`,
        },
        "TransactionUI:customer:getByCustomerAndDate:Clicked": {
          method: "GET",
          path: ({ globals, pagination }) =>
            `/api/transactions/by-customer-and-date?customerId=${encodeURIComponent(
              globals.userId
            )}&startDate=${encodeURIComponent(
              pagination.startDate
            )}&endDate=${encodeURIComponent(
              pagination.endDate
            )}&limit=${encodeURIComponent(
              pagination.limit
            )}&offset=${encodeURIComponent(pagination.offset)}`,
        },
        "TransactionUI:customer:getAllByCustomerAndDate:Clicked": {
          method: "GET",
          path: ({ globals, pagination }) =>
            `/api/transactions/by-customer-and-date/all?customerId=${encodeURIComponent(
              globals.userId
            )}&startDate=${encodeURIComponent(
              pagination.startDate
            )}&endDate=${encodeURIComponent(pagination.endDate)}`,
        },

        // Order type queries
        "TransactionUI:orderType:getByOrderType:Clicked": {
          method: "GET",
          path: ({ globals, pagination }) =>
            `/api/transactions/by-order-type/${encodeURIComponent(
              globals.orderType
            )}?limit=${encodeURIComponent(
              pagination.limit
            )}&offset=${encodeURIComponent(pagination.offset)}`,
        },

        // Globals
        "TransactionUI:global:FillDemoIds": {
          method: "NONE",
          path: null,
        },
      };

      // Global event handlers
      window.addEventListener("TransactionUI:global:FillDemoIds", (ev) => {
        const scope = document.querySelector('[data-scope="global-inputs"]');
        ensureEl(scope, "global inputs");
        const paginationScope = document.querySelector('[data-scope="pagination-inputs"]');
        ensureEl(paginationScope, "pagination inputs");
        
        const fill = (sel, val) => {
          const el = scope.querySelector(sel);
          if (el) el.value = val;
        };
        const fillPagination = (sel, val) => {
          const el = paginationScope.querySelector(sel);
          if (el) el.value = val;
        };
        
        const rand = (p) => p + "_" + Math.random().toString(36).slice(2, 8);
        fill('[data-field="transactionId"]', Math.floor(Math.random() * 1000) + 1);
        fill('[data-field="userId"]', rand("CUST"));
        fill('[data-field="ownerId"]', rand("OWNER"));
        fill('[data-field="status"]', "active");
        fill('[data-field="statusCount"]', "active");
        fill('[data-field="orderType"]', "refund");
        
        // Set default dates
        const startDate = new Date();
        startDate.setMonth(startDate.getMonth() - 6);
        const endDate = new Date();
        
        const fillDate = (sel, date) => {
          const el = paginationScope.querySelector(sel);
          if (el) el.value = date.toISOString().split('T')[0];
        };
        
        fillDate('[data-field="startDate"]', startDate);
        fillDate('[data-field="endDate"]', endDate);
      });

      // Unified router
      Object.keys(routes).forEach((eventName) => {
        window.addEventListener(eventName, async (ev) => {
          console.log('Event received:', eventName);
          const cfg = routes[eventName];
          if (!cfg) {
            console.error('No route config found for:', eventName);
            return;
          }
          const detail = ev.detail || {};

          if (cfg.method === "NONE") {
            showOut({ ok: true, data: { note: "Filled demo IDs" } });
            return;
          }

          try {
            // Get global values
            const globals = {};
            const globalScope = document.querySelector('[data-scope="global-inputs"]');
            if (globalScope) {
              const fields = globalScope.querySelectorAll('[data-field]');
              fields.forEach(field => {
                globals[field.dataset.field] = field.value;
              });
            }

            // Get pagination values
            const pagination = {};
            const paginationScope = document.querySelector('[data-scope="pagination-inputs"]');
            if (paginationScope) {
              const fields = paginationScope.querySelectorAll('[data-field]');
              fields.forEach(field => {
                pagination[field.dataset.field] = field.value;
              });
            }

            // Get all other form values from any scope
            const allFields = document.querySelectorAll('[data-field]');
            allFields.forEach(field => {
              const fieldName = field.dataset.field;
              const fieldValue = field.value;
              
              // Add to globals if not already there
              if (!globals[fieldName]) {
                globals[fieldName] = fieldValue;
              }
            });

            console.log('Globals:', globals);
            console.log('Pagination:', pagination);

            const method = cfg.method;
            const path = typeof cfg.path === "function" ? cfg.path({ globals, pagination }) : cfg.path;
            const body = cfg.buildBody ? cfg.buildBody(detail) : undefined;

            console.log('Making request:', method, path);

            const res = await apiFetch(path, { method, body });
            showOut(res);
          } catch (err) {
            console.error('Error in event handler:', err);
            showOut({ 
              success: false, 
              error: err.message || String(err),
              timestamp: new Date().toISOString(),
              event: eventName
            });
          }
        });
      });

      // Click event handler for buttons with data-dispatch
      document.addEventListener('click', (ev) => {
        const button = ev.target.closest('[data-dispatch]');
        if (button) {
          const eventName = button.dataset.dispatch;
          console.log('Button clicked, dispatching:', eventName);
          emit(eventName);
        }
      });

      // Initialize with demo data
      window.addEventListener('load', () => {
        emit("TransactionUI:global:FillDemoIds");
      });
    </script>
  </body>
</html>